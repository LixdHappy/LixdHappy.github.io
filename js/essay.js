!function(){"use strict";const e={api_url:"https://ech0.gbfun.cc/api/echo/page",page_limit:30,index_limit:10,cache_ttl:18e5,name:"Ech0",avatar:"/img/avatar.png"},n=()=>window.Ech0Config?{...e,...window.Ech0Config}:e;async function t(e){const t=n(),a="ech0_essay_cache",i="ech0_essay_cache_time";try{const n=localStorage.getItem(a),s=localStorage.getItem(i),o=Date.now();if(n&&s&&o-parseInt(s)<t.cache_ttl){return JSON.parse(n).slice(0,e)}const r=await fetch(t.api_url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({page:1,pageSize:Math.max(e,t.page_limit)})}),c=await r.json();if(1===c.code&&c.data&&Array.isArray(c.data.items)){const n=c.data.items;return localStorage.setItem(a,JSON.stringify(n)),localStorage.setItem(i,o.toString()),n.slice(0,e)}return[]}catch(e){return console.error("Ech0 API 获取失败:",e),[]}}function a(e){const n=new Date-new Date(e),t=6e4,a=36e5,i=24*a,s=30*i;return n<t?"刚刚":n<a?Math.floor(n/t)+" 分钟前":n<i?Math.floor(n/a)+" 小时前":n<s?Math.floor(n/i)+" 天前":function(e){const n=new Date(e),t=e=>e.toString().padStart(2,"0");return`${n.getFullYear()}-${t(n.getMonth()+1)}-${t(n.getDate())} ${t(n.getHours())}:${t(n.getMinutes())}`}(e)}function i(e){if(!e)return"";const n=document.createElement("div");return n.textContent=e,n.innerHTML}async function s(){const e=document.querySelector("#essay_page #waterfall"),s=document.querySelector("#essay_page #bber-tips");if(!e)return;const o=n(),r=await t(o.page_limit);if(0===r.length)return e.innerHTML='<li class="bber-item"><div class="bber-content"><p class="datacont">暂无内容</p></div></li>',void(s&&(s.textContent="- 暂无短文 -"));let c="";r.forEach(e=>{c+=function(e,n){const t=e.content||"",s=e.created_at||(new Date).toISOString(),o=Array.isArray(e.images)?e.images:[],r=e.extension_type||"",c=e.extension||"",l=e.location||"",d=Array.isArray(e.tags)&&e.tags.length?e.tags.map(e=>e.name||e):[];let u=`\n      <li class="bber-item">\n        <div class="user-avatar" style="background: url(${n.avatar}) left 28% / cover no-repeat #ffffffad;"></div>\n        <div class="bber-content">\n          <div class="right">\n            <div class="bber-name">${n.name}</div>\n            <p class="datacont">${i(t)}`;if(o.length>0&&(u+='<div class="bber-container-img">',o.forEach(e=>{const n=e.image_url||e;u+=`\n          <a class="bber-content-img" href="${n}" target="_blank" data-fancybox="gallery" data-caption="">\n            <img src="${n}" loading="lazy">\n          </a>`}),u+='<div class="bber-content-noimg"></div><div class="bber-content-noimg"></div><div class="bber-content-noimg"></div>',u+="</div>"),"VIDEO"===r&&c){if(u+='<div class="bber-video-container">',c.startsWith("BV")||c.includes("bilibili")){const e=c.startsWith("BV")?c:c.match(/BV[\w]+/)?.[0]||c;u+=`\n          <div class="bilibiliPlayer">\n            <iframe src="https://www.bilibili.com/blackboard/html5mobileplayer.html?bvid=${e}&as_wide=1&high_quality=1&danmaku=0" \n                    scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" loading="lazy"></iframe>\n          </div>`}else if(c.includes("youtube")||c.match(/^[\w-]{11}$/)){const e=c.match(/^[\w-]{11}$/)?c:c.match(/(?:v=|\/)[\w-]{11}/)?.[1]||c;u+=`\n          <div class="youtubePlayer">\n            <iframe src="https://www.youtube.com/embed/${e}" \n                    frameborder="0" allowfullscreen loading="lazy"></iframe>\n          </div>`}else u+=`\n          <a class="bber-content-video" href="${c}" data-fancybox="gallery" data-caption="">\n            <video src="${c}" preload="metadata"></video>\n          </a>`;u+="</div>"}if("MUSIC"===r&&c){const e=function(e){if(!e)return null;let n="",t="";if(e.includes("music.163.com")){n="netease";const a=e.match(/id=(\d+)/);t=a?a[1]:""}else if(e.includes("y.qq.com")){n="tencent";const a=e.match(/songid=(\d+)/)||e.match(/id=(\d+)/);t=a?a[1]:""}return n&&t?{server:n,id:t}:null}(c);e&&(u+=`\n          <div class="bber-music">\n            <meting-js id="${e.id}" server="${e.server}" type="song" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="list"></meting-js>\n          </div>`)}if(("WEBSITE"===r||"GITHUBPROJ"===r)&&c){let e="",n="";try{const t="string"==typeof c?JSON.parse(c):c;e=t.site||t.url||c,n=t.title||e}catch{e=c,n=c}if("GITHUBPROJ"===r){const t=e.match(/github\.com\/[^/]+\/([^/?#]+)/);t&&(n=t[1])}u+=`\n        <div class="bber-external-link">\n          <a href="${e}" target="_blank" rel="nofollow noopener" class="external-link">\n            <i class="anzhiyufont anzhiyu-icon-link"></i>\n            <span>${i(n)}</span>\n          </a>\n        </div>`}if(u+="</p>",u+='<hr class="essay-hr">',u+=`\n            <div class="bber-bottom">\n              <div class="bber-info">\n                <div class="bber-info-time">\n                  <i class="anzhiyufont anzhiyu-icon-clock"></i>\n                  <time class="datatime" datetime="${s}" style="display: inline;">${a(s)}</time>\n                </div>`,d.length>0){const e=d.join(", ");u+=`\n                <div class="essay-tag">\n                  <i class="anzhiyufont anzhiyu-icon-tags faa-tada"></i>\n                  <span>${i(e)}</span>\n                </div>`}if(("WEBSITE"===r||"GITHUBPROJ"===r)&&c){let e="";try{const n="string"==typeof c?JSON.parse(c):c;e=n.site||n.url||c}catch{e=c}u+=`\n                <a class="bber-content-link" title="跳转到短文指引的链接" href="${e}" rel="external nofollow" target="_blank">\n                  <i class="anzhiyufont anzhiyu-icon-link"></i>链接\n                </a>`}return l&&(u+=`\n                <div class="bber-info-address">\n                  <i class="anzhiyufont anzhiyu-icon-location"></i>\n                  <span>${i(l)}</span>\n                </div>`),u+=`\n              </div>\n              <div class="bber-reply" onclick="rm && rm.rightMenuCommentText('${i(t.replace(/'/g,"\\'"))}')">\n                <i class="anzhiyufont anzhiyu-icon-message"></i>\n              </div>\n            </div>\n          </div>\n        </div>\n      </li>`,u}(e,o)}),e.innerHTML=c,s&&(s.textContent=`- 只展示最近${r.length}条短文 -`),"undefined"!=typeof anzhiyu&&anzhiyu.reflashEssayWaterFall&&anzhiyu.reflashEssayWaterFall(),"undefined"!=typeof anzhiyu&&anzhiyu.changeTimeInEssay&&anzhiyu.changeTimeInEssay(),"undefined"!=typeof anzhiyu&&anzhiyu.loadLightbox&&anzhiyu.loadLightbox(document.querySelectorAll("#essay_page img:not(.no-lightbox)"))}async function o(){const e=document.querySelector("#bbTimeList #bber-talk");if(!e)return;const a=n(),s=await t(a.index_limit);if(0===s.length)return void(e.innerHTML='<a class="li-style swiper-slide" href="/essay/">暂无内容</a>');let o="";const c="undefined"!=typeof pjax?"javascript:void(0);":"/essay/";s.forEach(e=>{let n=e.content||"";e.images&&e.images.length>0&&(n+=" [图片]"),"VIDEO"===e.extension_type&&(n+=" [视频]"),"MUSIC"===e.extension_type&&(n+=" [音乐]"),"WEBSITE"!==e.extension_type&&"GITHUBPROJ"!==e.extension_type||(n+=" [链接]"),o+=`<a class="li-style swiper-slide" href="${c}">${i(n)}</a>`}),e.innerHTML=o,r()}function r(){if("undefined"==typeof Swiper)return void setTimeout(r,100);const e=document.querySelector(".essay_bar_swiper_container");if(!e)return;e.swiper&&e.swiper.destroy(!0,!0);const n=new Swiper(".essay_bar_swiper_container",{passiveListeners:!0,direction:"vertical",loop:!0,autoplay:{disableOnInteraction:!0,delay:3e3},mousewheel:!0}),t=document.getElementById("bbtalk");t&&(t.onmouseenter=function(){n.autoplay.stop()},t.onmouseleave=function(){n.autoplay.start()})}function c(){const e=document.getElementById("essay_page"),n=document.getElementById("bbTimeList");e&&s(),n&&o()}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",c):c(),document.addEventListener("pjax:complete",c),window.Ech0Essay={init:c,renderPage:s,renderBar:o,fetchData:t}}();